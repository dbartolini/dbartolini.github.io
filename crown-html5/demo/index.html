<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crown Physics Sample</title>
<style>
  body { 
    background-color: black;
    font-family:  system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin: 0;
  }
  .app { 
    background-color: black;
    border: 0px;
    display: block;
    height: 100%;
    left: 0;
    margin: 0px;
    position: absolute;
    top: 0;
    width: 100%;
  }
  #crown_logo {
    background-image: url('logo.svg');
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));
    height: 64px;
    left: 50%;
    margin: auto;
    top: 50%;
    width: 64px;
    z-index: 9999;
  }
  #loading_bar {
    display: block;
    margin: auto;
  }
  .centered {
    position: absolute;
    left: 50%;
    top: 50%;
    -webkit-transform: translate(-50%, -50%);
    transform: translate(-50%, -50%);
    width: 100%;
  }
  .message h1 {
    color: #fff;
    text-align: center;
    font-size: 20px;
  }
  .message p {
    color: #fff;
    text-align: center;
    margin: 0;
    opacity: 0.95;
  }
</style>
</head>
<body>
<script src="../enable-threads.js"></script>
<script src="../detect-mobile.js"></script>
<canvas id="canvas" class="app" oncontextmenu="event.preventDefault()" tabindex="-1" style="display:none;"></canvas>
<script>
(function(){
'use strict';

if (window.MobileDetected)
  return;

var canvas = document.getElementById('canvas');
canvas.style.display = 'block';

(function createOverlay() {
  var loading_overlay = document.createElement('div');
  loading_overlay.className = 'centered';
  loading_overlay.innerHTML = '<div id="crown_logo"></div><canvas id="loading_bar"></canvas>';
  document.body.appendChild(loading_overlay);

  var loading_bar = document.getElementById('loading_bar');
  var ctx = loading_bar.getContext('2d');
  
  function resize() {
    var dpr = window.devicePixelRatio || 1;
    loading_bar.width = Math.max(1, Math.floor(800 * dpr));
    loading_bar.height = Math.max(1, Math.floor(100 * dpr));
    loading_bar.style.width = loading_bar.width + 'px';
    loading_bar.style.height = loading_bar.height + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener('resize', resize);
  resize();

  function clear() { 
    ctx.clearRect(0, 0, loading_bar.clientWidth, loading_bar.clientHeight);
  }

  function roundRect(ctx, x, y, w, h, r) {
    if (typeof r === 'undefined') 
      r = 5;

    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.arcTo(x + w, y, x + w, y + h, r);
    ctx.arcTo(x + w, y + h, x, y + h, r);
    ctx.arcTo(x, y + h, x, y, r);
    ctx.arcTo(x, y, x + w, y, r);
    ctx.closePath();
  }

  function drawProgress(ratio, label) {
    clear();

    var W = loading_bar.clientWidth, H = loading_bar.clientHeight;
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,W,H);
    
    var barW = Math.min(600, W * 0.6), barH = 8;
    var x = (W - barW) / 2, y = (H - barH) / 2;

    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.lineWidth = 2;
    roundRect(ctx, x - 2, y - 2, barW + 4, barH + 4, 6);
    ctx.stroke();

    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    roundRect(ctx, x, y, barW, barH, 4);
    ctx.fill();

    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    var fillW = Math.max(1, Math.floor(barW * ratio));
    roundRect(ctx, x, y, fillW, barH, 4);
    ctx.fill();

    ctx.fillStyle = 'white';
    ctx.font = '14px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    var text = label || Math.round(ratio * 100) + '%';
    ctx.fillText(text, W/2, y - 8);
  }

  window.LoadingOverlay = {
    drawProgress: drawProgress,
    clear: clear,
    remove: function () {
      try {
        window.removeEventListener('resize', resize);
        if (loading_overlay.parentNode) 
          loading_overlay.parentNode.removeChild(loading_overlay);
      } catch (e) {}
    }
  };
})();

window.Module = {
  preRun: [], postRun: [],
  canvas: (function() { 
      var c = document.getElementById('canvas'); 
      c.addEventListener('webglcontextlost', function(e) { 
        alert('WebGL context lost. Reload page.'); 
        e.preventDefault(); 
      }, false); 
    return c; 
  })(),

  setStatus: function(text) {
    if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
    if (text === Module.setStatus.text) return;
    var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
    if (m) {
      var loaded = parseInt(m[2]);
      var total = parseInt(m[4]);
      var ratio = (total > 0) ? Math.min(1, loaded/total) : 0;
      var percent = Math.round(ratio*100);
      var label = m[0];

      if (window.LoadingOverlay)
        window.LoadingOverlay.drawProgress(ratio, label);
    } else {
      if (!text && window.LoadingOverlay)
        window.LoadingOverlay.remove();
    }
  },
  totalDependencies: 0,
  monitorRunDependencies: function(left) {
    this.totalDependencies = Math.max(this.totalDependencies, left);
    Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
  }
};

(function loadEmscriptenScripts(){
  var scripts = ['data.js', 'crown-release.js'];
  for (var i=0;i<scripts.length;i++){
    var s = document.createElement('script');
    s.type = 'text/javascript';
    s.async = true;
    s.src = scripts[i];
    document.body.appendChild(s);
  }
})();

})();
</script>
</body>
</html>
